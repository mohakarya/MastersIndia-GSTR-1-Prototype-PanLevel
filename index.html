<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Masters India GSTR-1 Prototype</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; }
/* Custom scrollbar for better aesthetics */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
</head>
<body class="h-screen overflow-hidden">
<div id="root" class="h-full"></div>

<script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const IconWrapper = ({ children, size = 24, className = "", ...props }) => (
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={`lucide ${className}`}
            {...props}
        >
            {children}
        </svg>
    );

    // Icons
    const LayoutDashboard = (props) => <IconWrapper {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconWrapper>;
    const UploadCloud = (props) => <IconWrapper {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></IconWrapper>;
    const FileText = (props) => <IconWrapper {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconWrapper>;
    const Receipt = (props) => <IconWrapper {...props}><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 17V7"/></IconWrapper>;
    const Calculator = (props) => <IconWrapper {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y1="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>;
    const CreditCard = (props) => <IconWrapper {...props}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconWrapper>;
    const Bell = (props) => <IconWrapper {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconWrapper>;
    const Menu = (props) => <IconWrapper {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconWrapper>;
    const CheckCircle2 = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconWrapper>;
    const AlertTriangle = (props) => <IconWrapper {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>;
    const ArrowLeft = (props) => <IconWrapper {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>;
    const ArrowRight = (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconWrapper>;
    const Download = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-3-3v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>;
    const RefreshCw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>;
    const Trash2 = (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>;
    const Edit = (props) => <IconWrapper {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></IconWrapper>;
    const Plus = (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
    const Filter = (props) => <IconWrapper {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconWrapper>;
    const Search = (props) => <IconWrapper {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>;
    const ChevronDown = (props) => <IconWrapper {...props}><path d="m6 9 6 6 6-6"/></IconWrapper>;
    const Eye = (props) => <IconWrapper {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
    const Grid = (props) => <IconWrapper {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconWrapper>;
    const HelpCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconWrapper>;
    const Check = (props) => <IconWrapper {...props}><polyline points="20 6 9 17 4 12"/></IconWrapper>;
    const Settings = (props) => <IconWrapper {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l-.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
    const FileCheck = (props) => <IconWrapper {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></IconWrapper>;
    const LogOut = (props) => <IconWrapper {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconWrapper>;
    const MoreHorizontal = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></IconWrapper>;
    const RotateCcw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>;
    const Link = (props) => <IconWrapper {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconWrapper>;
    const List = (props) => <IconWrapper {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconWrapper>;
    const LayoutGrid = (props) => <IconWrapper {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></IconWrapper>;
    const FileUp = (props) => <IconWrapper {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 12v6"/><path d="M9 15l3-3 3 3"/></IconWrapper>;
    const Info = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconWrapper>;
    const ArrowUpDown = (props) => <IconWrapper {...props}><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></IconWrapper>;
    const HardDriveDownload = (props) => <IconWrapper {...props}><path d="M12 2v8"/><path d="m16 6-4 4-4-4"/><rect width="20" height="8" x="2" y="14" rx="2"/><path d="M6 18h.01"/><path d="M10 18h.01"/></IconWrapper>;
    const FileWarning = (props) => <IconWrapper {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 17v-4"/><path d="M12 8h.01"/></IconWrapper>;

    // --- Mock Data ---

    const ALL_PAN_DATA = [
        {
            pan: "ABCDE1234F",
            legalName: "MASTERS INDIA PRIVATE LIMITED (HQ)",
            gstins: [
                { id: "06AACJJ1111H1ZK", state: "06-Haryana", branch: "Gurugram HQ", status: "Ready", taxableValue: 650000, liability: 120000, errorCount: 0, uploadStatus: "Uploaded", returnPeriod: "Nov 2025", filingType: "EVC", otpStatus: "Verified" },
                { id: "07AACJJ1111H1Z2", state: "07-Delhi", branch: "Delhi Sales", status: "Error", taxableValue: 250000, liability: 45000, errorCount: 3, uploadStatus: "Pending", returnPeriod: "-", filingType: "EVC", otpStatus: "Pending" },
                { id: "27AACJJ1111H1Z5", state: "27-Maharashtra", branch: "Mumbai Warehouse", status: "Ready", taxableValue: 480000, liability: 85000, errorCount: 0, uploadStatus: "Uploaded", returnPeriod: "Nov 2025", filingType: "EVC", otpStatus: "Verified" },
                { id: "29AACJJ1111H1Z8", state: "29-Karnataka", branch: "Bangalore Tech", status: "Pending", taxableValue: 0, liability: 0, errorCount: 0, uploadStatus: "Pending", returnPeriod: "-", filingType: "EVC", otpStatus: "Expired" },
                { id: "33AACJJ1111H1Z1", state: "33-Tamil Nadu", branch: "Chennai Hub", status: "Ready", taxableValue: 70000, liability: 0, errorCount: 0, uploadStatus: "Uploaded", returnPeriod: "Nov 2025", filingType: "EVC", otpStatus: "Verified" },
            ]
        },
        {
            pan: "FGHIJ5678K",
            legalName: "ALPHA SOLUTIONS CORP (Secondary)",
            gstins: [
                { id: "24FGHIJ5678K1Z3", state: "24-Gujarat", branch: "Ahmedabad Branch", status: "Ready", taxableValue: 320000, liability: 60000, errorCount: 0, uploadStatus: "Uploaded", returnPeriod: "Nov 2025", filingType: "DSC", otpStatus: "Verified" },
                { id: "33FGHIJ5678K1Z4", state: "33-Tamil Nadu", branch: "Chennai Office", status: "Error", taxableValue: 150000, liability: 25000, errorCount: 1, uploadStatus: "Pending", returnPeriod: "-", filingType: "EVC", otpStatus: "Pending" },
            ]
        }
    ];

    // Derived Data (Keep original names for local component consumption if possible)
    const PAN_INFO = ALL_PAN_DATA[0]; // Default to first PAN for initial display

    // Data for Masters India Data Summary (Left Panel)
    const MASTER_INDIA_DATA = {
        invoiceSummary: [
            { type: "B2CLA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "EXP", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "EXPA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "AT", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "ATA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "TXPD", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "TXPDA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
        ],
        nilSupply: [
            { type: "NIL", count: '--', nil: "₹0.00", exempted: "₹0.00", nonGst: "₹0.00" },
        ],
        docIssue: [
            { type: "DOC ISSUE", totalIssued: 0, cancelled: 0, netIssued: 0 },
        ]
    };

    // Updated Data for GST Portal Summary (Right Panel)
    const GST_PORTAL_DATA = {
        invoiceSummary: [
            { type: "B2B", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "B2BA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "CDNR", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "CDNRA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "CDNUR", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "B2CL", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "B2CLA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "EXP", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "EXPA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "AT", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "ATA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "TXPD", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
            { type: "TXPDA", count: '--', invoiceValue: "₹0.00", taxableValue: "₹0.00", totalTax: "₹0.00" },
        ],
        nilSupply: [
            { type: "NIL", count: '--', nil: "₹0.00", exempted: "₹0.00", nonGst: "₹0.00" },
        ],
        docIssue: [
            { type: "DOC ISSUE", totalIssued: 0, cancelled: 0, netIssued: 0 },
        ]
    };
    // End of new mock data

    // RE-ADDED MISSING ARRAYS
    const OVERVIEW_INVOICE_CARDS = [
        { title: "B2B Invoice", count: 12, value: "₹ 1,20,000.00", tax: "₹ 21,600.00" },
        { title: "Amended B2B Invoice", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "B2C Large", count: 5, value: "₹ 45,000.00", tax: "₹ 8,100.00" },
        { title: "Amended B2C Large", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Credit/Debit Note [R]", count: 2, value: "₹ -10,000.00", tax: "₹ -1,800.00" },
        { title: "Amended Credit/Debit Note [R]", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Credit/Debit Note [UR]", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Amended Credit/Debit Note [UR]", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Export", count: 1, value: "₹ 50,000.00", tax: "₹ 0.00" },
        { title: "Export Amended", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Supplies U/s 9(5)", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Amended Supplies U/s 9(5)", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
    ];

    const OVERVIEW_OTHER_CARDS = [
        { title: "B2C Small", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "B2CA Small", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Nil Rated Supply", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Advance Received in Current Tax Period", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Advance Received in Earlier Tax Period", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Amended Advance Received in Current Tax Period", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Amended Advance Received in Earlier Tax Period", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "HSN Summary (B2B)", count: 15, value: "₹ 2,40,000.00", tax: "₹ 18,000.00" },
        { title: "HSN Summary (B2C)", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Document Summary", count: 22, value: "-", tax: "-" },
        { title: "Supplies made through E-Commerce Operators", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Amended Supplies made through E-Commerce Operators", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
    ];

    // Added missing list of cards for consolidated view
    const PAN_INVOICE_SUMMARY_CARDS = [
        { title: "B2B Invoice", count: 17, invoiceValue: "₹2,50,000.00", taxableValue: "₹2,20,000.00", taxLiability: "₹39,600.00" },
        { title: "Amended B2B Invoice", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "B2C Large", count: 8, invoiceValue: "₹90,000.00", taxableValue: "₹80,000.00", taxLiability: "₹14,400.00" },
        { title: "Amended B2C Large", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Credit/Debit Note [R]", count: 4, invoiceValue: "₹-25,000.00", taxableValue: "₹-20,000.00", taxLiability: "₹-3,600.00" },
        { title: "Amended Credit/Debit Note [R]", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Credit/Debit Note [UR]", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Amended Credit/Debit Note [UR]", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Export", count: 2, invoiceValue: "₹1,00,000.00", taxableValue: "₹1,00,000.00", taxLiability: "₹0.00" },
        { title: "Export Amended", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Supplies U/s 9(5)", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Amended Supplies U/s 9(5)", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
    ];
    // Added missing list of cards for consolidated view - other details
     const PAN_OTHER_DETAIL_SUMMARY_CARDS = [
        { title: "B2C Small", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "B2CA Small", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Nil Rated Supply", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Advance Received in Current Tax Period", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Advance Received in Earlier Tax Period", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Amended Advance Received in Current Tax Period", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "Amended Advance Received in Earlier Tax Period", count: 0, invoiceValue: "₹0.00", taxableValue: "₹0.00", taxLiability: "₹0.00" },
        { title: "HSN Summary (B2B)", count: 20, value: "₹ 3,50,000.00", tax: "₹ 30,000.00" },
        { title: "HSN Summary (B2C)", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Document Summary", count: 35, value: "-", tax: "-" },
        { title: "Supplies made through E-Commerce Operators", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
        { title: "Amended Supplies made through E-Commerce Operators", count: 0, value: "₹ 0.00", tax: "₹ 0.00" },
    ];


    const UPLOAD_HISTORY_DATA = [
        { id: "1", gstin: "06AACJJ1111H1ZK", category: "Data Import", uploadType: "Summary Upload", uploadDate: "27 Nov 2025, 10:30 AM", uploadedBy: "Rahul Sharma", status: "Processed", errorFile: null },
        { id: "2", gstin: "07AACJJ1111H1Z2", category: "Invoice Data", uploadType: "Invoice Upload", uploadDate: "26 Nov 2025, 04:15 PM", uploadedBy: "Priya Singh", status: "Failed", errorFile: "error_2611.xlsx" },
        { id: "3", gstin: "27AACJJ1111H1Z5", category: "Data Import", uploadType: "Summary Upload", uploadDate: "26 Nov 2025, 01:00 PM", uploadedBy: "Amit Patel", status: "Processed", errorFile: null },
        { id: "4", gstin: "06AACJJ1111H1ZK", category: "Invoice Data", uploadType: "Invoice Upload", uploadDate: "25 Nov 2025, 11:45 AM", uploadedBy: "Rahul Sharma", status: "Processed", errorFile: null },
        { id: "5", gstin: "33AACJJ1111H1Z1", category: "Data Import", uploadType: "Summary Upload", uploadDate: "25 Nov 2025, 09:30 AM", uploadedBy: "Sneha Reddy", status: "Processed", errorFile: null },
    ];

    const PREPARE_SECTIONS = [
        "B2CS Summary",
        "B2CSA Summary",
        "Nil Rated, Exempted, Non GST Summary",
        "Advance Received in Current Tax Period",
        "Amended Advance Received in Current Tax Period",
        "Advance Received in Earlier Tax Period",
        "Amended Advance Received in Earlier Tax Period",
        "HSN Summary",
        "Document Summary",
        "Supplies made through E-Commerce Operators",
        "Amended Supplies made through E-Commerce Operators"
    ];

    // --- Reusable Components ---

    const SidebarItem = ({ icon: Icon, label, active, badge }) => (
        <div className={`
            flex items-center px-4 py-3.5 text-sm font-medium cursor-pointer transition-all border-l-4
            ${active
            ? 'bg-blue-50 text-blue-800 border-blue-800'
            : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-transparent'}
        `}>
            <Icon size={18} className={`mr-3 ${active ? 'text-blue-800' : 'text-gray-500'}`} />
            <span className="flex-1">{label}</span>
            {badge && (
            <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">
                {badge}
            </span>
            )}
        </div>
    );

    const StatusBadge = ({ status }) => {
        const config = {
            Ready: { color: 'text-green-700 bg-green-50 border-green-200', icon: CheckCircle2 },
            Error: { color: 'text-red-700 bg-red-50 border-red-200', icon: AlertTriangle },
            Pending: { color: 'text-gray-600 bg-gray-100 border-gray-200', icon: null },
            Uploaded: { color: 'text-green-700 bg-green-50 border-green-200', icon: null },
            Filed: { color: 'text-blue-700 bg-blue-50 border-blue-200', icon: FileCheck },
            'OTP Error': { color: 'text-orange-700 bg-orange-50 border-orange-200', icon: AlertTriangle }
        };
        const { color, icon: Icon } = config[status] || config.Pending;

        return (
            <span className={`inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium border ${color}`}>
            {Icon && <Icon size={12} className="mr-1.5" />}
            {status}
            </span>
        );
    };

    const UploadStatusBadge = ({ status }) => {
        const config = {
            Processed: { color: 'text-green-700 bg-green-50 border-green-200', icon: CheckCircle2 },
            Failed: { color: 'text-red-700 bg-red-50 border-red-200', icon: AlertTriangle },
        };
        const { color, icon: Icon } = config[status] || config.Processed;

        return (
            <span className={`inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium border ${color}`}>
            {Icon && <Icon size={12} className="mr-1.5" />}
            {status}
            </span>
        );
    };

    // Updated Invoice Card to support 4 fields explicitly
    const InvoiceCard = ({ title, count, invoiceValue, taxableValue, taxLiability, value, tax }) => {
        // Fallback for older card usage (Single View) which might use 'value' and 'tax' props
        const displayInvoiceValue = invoiceValue || value || "₹0.00";
        const displayTaxableValue = taxableValue || value || "₹0.00";
        const displayTaxLiability = taxLiability || tax || "₹0.00";

        return (
            <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-[0_1px_2px_rgba(0,0,0,0.05)] hover:shadow-md transition-shadow cursor-pointer group h-full flex flex-col">
                <div className="flex justify-between items-start mb-3">
                    <h3 className="text-xs font-bold text-blue-800 bg-blue-50 px-2 py-1 rounded group-hover:bg-blue-100 transition-colors uppercase tracking-wide line-clamp-2 h-auto min-h-[24px]">{title}</h3>
                </div>
                <div className="space-y-2 text-xs text-gray-600 mt-auto">
                    <div className="flex justify-between items-center border-b border-dashed border-gray-100 pb-1">
                        <span className="text-gray-500">Invoice Count</span>
                        <span className="font-bold text-gray-900">{count}</span>
                    </div>
                    <div className="flex justify-between items-center">
                        <span className="text-gray-500">Invoice Value</span>
                        <span className="font-medium text-gray-900">{displayInvoiceValue}</span>
                    </div>
                    <div className="flex justify-between items-center">
                        <span className="text-gray-500">Taxable Value</span>
                        <span className="font-medium text-gray-900">{displayTaxableValue}</span>
                    </div>
                    <div className="flex justify-between items-center pt-1 border-t border-gray-100">
                        <span className="text-gray-500 font-medium">Tax Liability</span>
                        <span className="font-bold text-gray-900">{displayTaxLiability}</span>
                    </div>
                </div>
            </div>
        );
    };

    const EmptyStateBlock = ({ title }) => (
        <div className="bg-white border border-gray-200 rounded-lg p-8 text-center mb-6 shadow-sm">
            <div className="flex flex-col items-center justify-center text-gray-400">
                <div className="w-16 h-16 bg-blue-50 rounded-lg flex items-center justify-center mb-3 text-blue-200">
                    <div className="w-8 h-2 bg-blue-200 rounded-sm"></div>
                </div>
                <span className="text-sm font-medium text-gray-500">No Data Found!</span>
            </div>
        </div>
    );

    // --- GSTIN Iterator Bar Component ---
    const GstinIteratorBar = ({ currentPan, gstins, editingIndex, setEditingIndex, setPanId, isCompareMode = false }) => {
        const [isDropdownOpen, setIsDropdownOpen] = useState(false);

        const isConsolidated = editingIndex === -1;
        const currentGstinData = isConsolidated ? null : gstins[editingIndex];

        const handleLocalNext = () => {
            let nextIndex = isConsolidated ? 0 : editingIndex + 1;
            if (nextIndex < gstins.length) {
                setEditingIndex(nextIndex);
            }
        };

        const handleLocalPrev = () => {
            if (editingIndex > 0) {
                setEditingIndex(prev => prev - 1);
            } else if (editingIndex === 0 && !isCompareMode) {
                setEditingIndex(-1);
            }
        };

        const handleDropdownSelect = (index) => {
            setEditingIndex(index);
            setIsDropdownOpen(false);
        };

        const handleConsolidatedSelect = () => {
            setEditingIndex(-1); // Use -1 for consolidated view
            setIsDropdownOpen(false);
        };

        const handlePanSelect = (panId) => {
            setPanId(panId);
            // Reset to consolidated view (-1) when switching PAN
            setEditingIndex(-1);
            setIsDropdownOpen(false);
        };

        return (
            <div className="bg-white border-b border-gray-200 px-6 py-3 sticky top-0 z-20 shadow-[0_2px_4px_rgba(0,0,0,0.02)] flex items-center justify-between">
                <button
                    onClick={handleLocalPrev}
                    // Disable if consolidated in non-Compare mode OR at the first GSTIN
                    disabled={isConsolidated && !isCompareMode || editingIndex === 0 && !isConsolidated}
                    className={`flex items-center space-x-1 text-sm font-medium px-3 py-1.5 rounded-md transition-colors ${isConsolidated && !isCompareMode || editingIndex === 0 && !isConsolidated ? 'text-gray-300 cursor-not-allowed' : 'text-blue-700 hover:bg-blue-50'}`}
                >
                    <ArrowLeft size={16} /> <span>Previous</span>
                </button>

                <div className="relative">
                    <button onClick={() => setIsDropdownOpen(!isDropdownOpen)} className="flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-all">
                        <div className="text-center">
                            <div className="text-sm font-bold text-gray-900 flex items-center justify-center gap-2">
                                {isConsolidated ? "PAN Level (Consolidated)" : currentGstinData.branch}
                                <ChevronDown size={14} className={`text-gray-400 transition-transform ${isDropdownOpen ? 'rotate-180' : ''}`} />
                            </div>
                            <div className="text-xs text-gray-500 font-mono tracking-wide">
                                {isConsolidated ? currentPan.pan : currentGstinData.id}
                            </div>
                        </div>
                    </button>
                    {isDropdownOpen && (
                        <>
                            <div className="fixed inset-0 z-30" onClick={() => setIsDropdownOpen(false)} />
                            <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-40 max-h-[400px] overflow-y-auto">

                                {/* Multi-PAN Switcher */}
                                <div className="px-4 py-2 bg-gray-50 border-b border-gray-100 text-xs font-semibold text-gray-500 uppercase flex justify-between items-center">
                                    <span>Switch PAN</span>
                                </div>
                                {ALL_PAN_DATA.map((panData) => (
                                    <div
                                        key={panData.pan}
                                        onClick={() => handlePanSelect(panData.pan)}
                                        className={`px-4 py-3 cursor-pointer hover:bg-blue-50 flex items-center justify-between group ${currentPan.pan === panData.pan ? 'bg-blue-50' : ''}`}
                                    >
                                        <div>
                                            <div className={`text-sm font-bold ${currentPan.pan === panData.pan ? 'text-blue-800' : 'text-gray-800'}`}>{panData.legalName}</div>
                                            <div className="text-xs text-gray-500 font-mono">{panData.pan}</div>
                                        </div>
                                        {currentPan.pan === panData.pan && <Check size={16} className="text-blue-600" />}
                                    </div>
                                ))}

                                <div className="px-4 py-2 bg-gray-50 border-b border-gray-100 text-xs font-semibold text-gray-500 uppercase mt-2">GSTIN View (Under {currentPan.pan})</div>

                                {/* Consolidated Option - only show if not in compare mode */}
                                {!isCompareMode && (
                                    <div
                                        onClick={handleConsolidatedSelect}
                                        className={`px-4 py-3 cursor-pointer hover:bg-blue-50 flex items-center justify-between group border-b border-gray-50 ${editingIndex === -1 ? 'bg-blue-50' : ''}`}
                                    >
                                        <div>
                                            <div className={`text-sm font-bold ${editingIndex === -1 ? 'text-blue-800' : 'text-gray-800'}`}>PAN Level (Consolidated)</div>
                                            <div className="text-xs text-gray-500 font-mono">{currentPan.pan}</div>
                                        </div>
                                        {editingIndex === -1 && <Check size={16} className="text-blue-600" />}
                                    </div>
                                )}

                                <div className="px-4 py-2 bg-gray-50 border-b border-gray-100 text-xs font-semibold text-gray-500 uppercase">Individual Branches</div>

                                {gstins.map((gstin, idx) => (
                                    <div key={gstin.id} onClick={() => handleDropdownSelect(idx)} className={`px-4 py-3 cursor-pointer hover:bg-blue-50 flex items-center justify-between group ${editingIndex === idx && !isConsolidated ? 'bg-blue-50' : ''}`}>
                                        <div>
                                            <div className={`text-sm font-medium ${editingIndex === idx && !isConsolidated ? 'text-blue-800' : 'text-gray-700'}`}>{gstin.branch}</div>
                                            <div className="text-xs text-gray-500 font-mono">{gstin.id}</div>
                                        </div>
                                        {editingIndex === idx && !isConsolidated && <Check size={16} className="text-blue-600" />}
                                    </div>
                                ))}
                            </div>
                        </>
                    )}
                </div>

                <button
                    onClick={handleLocalNext}
                    disabled={editingIndex === gstins.length - 1}
                    className={`flex items-center space-x-1 text-sm font-medium px-3 py-1.5 rounded-md transition-colors ${editingIndex === gstins.length - 1 ? 'text-gray-300 cursor-not-allowed' : 'text-blue-700 hover:bg-blue-50'}`}
                >
                    <span>Next</span> <ArrowRight size={16} />
                </button>
            </div>
        );
    };
    // End of GSTIN Iterator Bar Component

    // --- Main App Component ---

    function App() {
        // State initialization based on new multi-PAN data structure
        const [currentPanId, setCurrentPanId] = useState(ALL_PAN_DATA[0].pan);
        const [viewMode, setViewMode] = useState('PAN');
        const [selectedGstinIndex, setSelectedGstinIndex] = useState(0); // Index within current PAN's gstins array
        const [activeTab, setActiveTab] = useState('Overview');
        const [editingIndex, setEditingIndex] = useState(0); // SET TO 0 BY DEFAULT TO SHOW SINGLE VIEW ON STARTUP (to match screenshot)
        const [uploadSubTab, setUploadSubTab] = useState('Pending');
        const [uploadViewType, setUploadViewType] = useState('Invoice');
        const [uploadMode, setUploadMode] = useState('Bulk');
        const [selectedForFiling, setSelectedForFiling] = useState([]);
        const [bulkSelectedGSTINs, setBulkSelectedGSTINs] = useState([]);
        const [filingMode, setFilingMode] = useState('EVC');

        const [showUploadSlideOver, setShowUploadSlideOver] = useState(false);
        const [slideOverGstin, setSlideOverGstin] = useState(null);

        const [isFiling, setIsFiling] = useState(false);
        const [filingProgress, setFilingProgress] = useState([]);
        const [overallProgress, setOverallProgress] = useState(0);

        const [confirmUploadData, setConfirmUploadData] = useState({
            show: false,
            gstinId: null,
            isBulk: false,
            isBulkUpload: false,
        });

        // Memoized derived states based on currentPanId
        const currentPanData = useMemo(() => {
            return ALL_PAN_DATA.find(p => p.pan === currentPanId);
        }, [currentPanId]);

        const gstins = useMemo(() => currentPanData ? currentPanData.gstins : [], [currentPanData]);

        // Memoized current GSTIN data based on editing index, accessible across components
        const currentEditingGstin = useMemo(() => {
            if (editingIndex === -1 || !gstins || gstins.length === 0) return null;
            return gstins[editingIndex];
        }, [editingIndex, gstins]);

        // Reset editing index if current GSTIN array changes (e.g., after PAN switch)
        useEffect(() => {
            // If we switch PAN, ensure the index is valid or reset to consolidated (-1)
            if (editingIndex !== -1 && (!gstins || editingIndex >= gstins.length)) {
                setEditingIndex(-1);
            } else if (editingIndex === -1 && viewMode === 'SINGLE' && gstins.length > 0) {
                 // Ensure single view defaults to the first GSTIN if PAN is switched
                setEditingIndex(0);
            }

            // If a consolidated view is active, ensure viewMode is set to PAN for the header display
            if (editingIndex === -1) {
                setViewMode('PAN');
            } else {
                setViewMode('SINGLE');
            }
        }, [gstins, editingIndex, viewMode]);

        const handleGlobalContextChange = (mode, index = 0) => {
            setViewMode(mode);
            if (mode === 'SINGLE') {
                setSelectedGstinIndex(index);
                setEditingIndex(index);
            } else if (mode === 'PAN') {
                setEditingIndex(-1);
            }
        };

        const handleFilingTypeChange = (id, type) => {
            // This logic is more complex now as it needs to update the nested structure in ALL_PAN_DATA
            // For simplicity in this prototype, we'll simulate the update on the active GSTINs array state
            // Note: A real app would need a state management solution or reducer for deep updates across PANs.
            // Since our GSTIN data is derived from currentPanData, we'll just update a local state array if needed.
            // For now, we'll skip deep state update complexity for this prototype.
            console.log(`Filing type changed for ${id} to ${type}`);
        };

        const handleViewGstin = (index) => {
            const gstin = gstins[index];
            setSlideOverGstin(gstin);
            setShowUploadSlideOver(true);
        };

        const handleRequestUpload = (id = null, isBulk = false) => {
             setConfirmUploadData({
                show: true,
                gstinId: id,
                isBulk: isBulk,
                isBulkUpload: id === null && isBulk,
            });
        };

        const executeUpload = () => {
            const { gstinId, isBulkUpload } = confirmUploadData;

            if (isBulkUpload) {
                const idsToUpload = bulkSelectedGSTINs;
                // Simplified: We only update the active GSTIN list.
                // A real app would need to update ALL_PAN_DATA structure.
                console.log(`Bulk Uploaded ${idsToUpload.length} GSTINs for PAN: ${currentPanId}`);
                setBulkSelectedGSTINs([]);
            } else if (gstinId) {
                console.log(`Uploaded data for GSTIN: ${gstinId}`);
            }

            setConfirmUploadData({ show: false, gstinId: null, isBulk: false, isBulkUpload: false });
        };

        const handleExportGstin = (id) => {
            console.log(`Exporting data for GSTIN ID: ${id}`);
        };

        const handleDownloadErrorFile = (filename) => {
             console.log(`Downloading error file: ${filename}`);
        };

        const handleFileReturn = (singleId = null) => {
            // Setup filing progress
            const gstinsToFile = singleId
                ? gstins.filter(g => g.id === singleId && g.status === 'Ready')
                : gstins.filter(g => selectedForFiling.includes(g.id) && g.status === 'Ready');

            if (gstinsToFile.length === 0) {
                alert("No GSTINs selected or ready for filing.");
                return;
            }

            const initialProgress = gstinsToFile.map(g => ({
                id: g.id,
                branch: g.branch,
                status: 'pending',
                message: 'Waiting to start...',
            }));

            setFilingProgress(initialProgress);
            setIsFiling(true);
            setOverallProgress(0);

            // Simulation of filing process
            let step = 0;
            const totalSteps = gstinsToFile.length * 3; // 3 steps per GSTIN (Start, Verify, File)
            let currentFilingIndex = 0;

            const fileNextGstin = () => {
                if (currentFilingIndex >= gstinsToFile.length) {
                    setOverallProgress(100);
                    setTimeout(() => {
                        // Reset filing after a short delay
                        setIsFiling(false);
                        setSelectedForFiling([]);
                        alert("Filing simulation complete!");
                    }, 2000);
                    return;
                }

                const currentGstin = gstinsToFile[currentFilingIndex];

                // Step 1: Start
                setTimeout(() => {
                    setFilingProgress(prev => prev.map(p => p.id === currentGstin.id ? { ...p, status: 'verifying', message: 'Starting process...' } : p));
                    step++;
                    setOverallProgress(Math.round((step / totalSteps) * 100));
                }, 500);

                // Step 2: Verify
                setTimeout(() => {
                    // 20% chance of failure for demo
                    const isSuccess = Math.random() > 0.2;
                    if (isSuccess) {
                        setFilingProgress(prev => prev.map(p => p.id === currentGstin.id ? { ...p, status: 'verifying', message: 'Verifying with GST Portal...' } : p));
                    } else {
                        setFilingProgress(prev => prev.map(p => p.id === currentGstin.id ? { ...p, status: 'failed', message: 'Verification Failed (Server Timeout)' } : p));
                        currentFilingIndex++;
                        fileNextGstin(); // Move to next even on failure
                    }
                    step++;
                    setOverallProgress(Math.round((step / totalSteps) * 100));
                }, 1500);

                // Step 3: File
                setTimeout(() => {
                    const status = filingProgress.find(p => p.id === currentGstin.id).status;
                    if (status !== 'failed') {
                        setFilingProgress(prev => prev.map(p => p.id === currentGstin.id ? { ...p, status: 'verified', message: 'Filed successfully! ACK: AA27022025' } : p));
                    }
                    step++;
                    setOverallProgress(Math.round((step / totalSteps) * 100));
                    currentFilingIndex++;
                    fileNextGstin(); // Continue recursion
                }, 3000);
            };

            fileNextGstin();
        };

        const handleViewPanDetails = () => {
            setActiveTab('Prepare');
            setEditingIndex(-1);
            handleGlobalContextChange('PAN');
        };

        const handleSwitchToPendingUpload = () => {
            setUploadSubTab('Pending');
        };

        // --- Modal Component ---
        const ConfirmationModal = ({ data, onConfirm, onCancel }) => {
            if (!data.show) return null;

            const isBulk = data.isBulkUpload;
            const uploadCount = isBulk ? bulkSelectedGSTINs.length : 1;
            const gstinName = isBulk ? `${uploadCount} GSTINs` : gstins.find(g => g.id === data.gstinId)?.branch;
            const message = isBulk
                ? `You are about to upload data for ${uploadCount} selected GSTINs to the GST Portal.`
                : `You are about to upload data for GSTIN: ${gstinName} to the GST Portal.`;

            return (
                <div className="fixed inset-0 z-[70] bg-gray-900 bg-opacity-50 flex items-center justify-center transition-opacity duration-300">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 animate-in fade-in zoom-in-95">
                        <div className="p-6">
                            <div className="text-center">
                                <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-orange-100 text-orange-600">
                                    <AlertTriangle size={24} />
                                </div>
                                <h3 className="mt-4 text-lg font-bold text-gray-900">Confirm Upload</h3>
                                <p className="mt-2 text-sm text-gray-500">
                                    {message}
                                    <br/>
                                    **This action cannot be undone.**
                                </p>
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 px-6 py-4 bg-gray-50 rounded-b-xl border-t border-gray-100">
                            <button
                                onClick={onCancel}
                                className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 shadow-md transition-colors"
                            >
                                Proceed to Upload
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Content Sections ---

        const OverviewContent = () => {
            const isConsolidatedView = editingIndex === -1;

            if (isConsolidatedView) {
                return (
                    <div className="p-6 space-y-8 animate-in fade-in duration-300 bg-[#f3f4f6] overflow-y-auto flex-1">
                        <div className="flex justify-between items-end">
                            <div>
                                <h2 className="text-lg font-bold text-gray-800">Consolidated Filing Status</h2>
                                <p className="text-sm text-gray-500 mt-1">PAN: <span className="font-mono text-gray-700 font-medium">{currentPanData.pan}</span> | {gstins.length} Registered Business Units</p>
                            </div>
                        </div>

                        <div className="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                            <div className="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                                <h3 className="text-sm font-bold text-gray-700">GSTIN Filing Summary</h3>
                                <button className="text-xs font-medium text-blue-700 hover:text-blue-900 flex items-center">
                                    <RefreshCw size={12} className="mr-1" /> Refresh All
                                </button>
                            </div>
                            <table className="w-full text-sm text-left">
                                <thead className="bg-white text-gray-500 border-b border-gray-100">
                                    <tr>
                                        <th className="px-6 py-3 font-medium">GSTIN / Branch</th>
                                        <th className="px-6 py-3 font-medium">State</th>
                                        <th className="px-6 py-3 font-medium text-right">Taxable Value</th>
                                        <th className="px-6 py-3 font-medium text-right">Tax Liability</th>
                                        <th className="px-6 py-3 font-medium">Status</th>
                                        <th className="px-6 py-3 font-medium text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {gstins.map((gstin, idx) => (
                                        <tr key={gstin.id} className="hover:bg-gray-50 transition-colors">
                                            <td className="px-6 py-4">
                                                <div className="font-medium text-gray-900">{gstin.branch}</div>
                                                <div className="text-xs text-gray-500 font-mono">{gstin.id}</div>
                                            </td>
                                            <td className="px-6 py-4 text-gray-600">{gstin.state}</td>
                                            <td className="px-6 py-4 text-right font-mono text-gray-600">₹ {gstin.taxableValue.toLocaleString()}</td>
                                            <td className="px-6 py-4 text-right font-mono font-medium text-gray-900">₹ {gstin.liability.toLocaleString()}</td>
                                            <td className="px-6 py-4"><StatusBadge status={gstin.status} /></td>
                                            <td className="px-6 py-4 text-right">
                                                {gstin.status === 'Error' ? (
                                                    <button
                                                        onClick={() => { setEditingIndex(idx); setActiveTab('Prepare'); }}
                                                        className="text-blue-600 hover:text-blue-800 text-xs font-semibold hover:underline"
                                                    >
                                                        Fix Errors
                                                    </button>
                                                ) : (
                                                    <button
                                                        onClick={() => { handleGlobalContextChange('SINGLE', idx); setEditingIndex(idx); }}
                                                        className="text-blue-600 hover:text-blue-800 text-xs font-semibold hover:underline"
                                                    >

                                                        View Details
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* Invoice Summary Section */}
                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-base font-bold text-gray-800">Invoice Summary</h2>
                                <button
                                    onClick={handleViewPanDetails}
                                    className="bg-[#1a2332] text-white px-4 py-2 rounded text-xs font-medium hover:bg-[#2c3e50] shadow-sm transition-colors flex items-center"
                                >
                                    <Eye size={14} className="mr-2"/> View Invoice
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {PAN_INVOICE_SUMMARY_CARDS.map((card, i) => (
                                    <InvoiceCard key={i} {...card} />
                                ))}
                            </div>
                        </div>

                        {/* Other Detail Summary Section */}
                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-base font-bold text-gray-800">Other Detail Summary</h2>
                                <button
                                    onClick={handleViewPanDetails}
                                    className="bg-[#1a2332] text-white px-4 py-2 rounded text-xs font-medium hover:bg-[#2c3e50] shadow-sm transition-colors flex items-center"
                                >
                                    <Eye size={14} className="mr-2"/> View Summary Details
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {PAN_OTHER_DETAIL_SUMMARY_CARDS.map((card, i) => (
                                    <InvoiceCard key={i} {...card} />
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // Single GSTIN View (when editingIndex is 0+)
            if (!currentEditingGstin) return null;

            return (
                <div className="flex flex-col h-full">
                    {/* ITERATOR BAR */}
                    <GstinIteratorBar
                        currentPan={currentPanData}
                        gstins={gstins}
                        editingIndex={editingIndex}
                        setEditingIndex={(index) => { setEditingIndex(index); setSelectedGstinIndex(index === -1 ? 0 : index); }}
                        setPanId={setCurrentPanId}
                        isCompareMode={false}
                    />
                    <div className="p-6 space-y-8 animate-in fade-in duration-300 flex-1 overflow-y-auto">
                         <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm mb-6">
                            <h2 className="text-lg font-bold text-gray-800">{currentEditingGstin.branch} Details</h2>
                            <p className="text-sm text-gray-500 font-mono">{currentEditingGstin.id}</p>
                        </div>
                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold text-gray-800">Invoice Summary</h2>
                                <button className="flex items-center space-x-2 bg-[#1a2332] text-white px-4 py-2 rounded text-xs font-medium hover:bg-[#2c3e50] shadow-sm transition-colors">
                                    <Eye size={14} /> <span>View Invoice</span>
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {OVERVIEW_INVOICE_CARDS.map((card, i) => (
                                    <InvoiceCard key={i} {...card} />
                                ))}
                            </div>
                        </div>
                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold text-gray-800">Other Detail Summary</h2>
                                <button className="flex items-center space-x-2 bg-[#1a2332] text-white px-4 py-2 rounded text-xs font-medium hover:bg-[#2c3e50] shadow-sm transition-colors">
                                    <Eye size={14} /> <span>View Summary Details</span>
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {OVERVIEW_OTHER_CARDS.map((card, i) => (
                                    <InvoiceCard key={i} {...card} />
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Reusable Single Upload View Component
        const SingleUploadViewUI = ({ gstin, isSlideOver = false, onClose }) => {
            const [localSubTab, setLocalSubTab] = useState('Pending');
            const [localViewType, setLocalViewType] = useState('Invoice');

            return (
                <div className="flex flex-col h-full bg-gray-50">
                     {/* Header if in SlideOver */}
                    {isSlideOver && (
                        <div className="bg-white px-6 py-4 border-b border-gray-200 flex justify-between items-center shrink-0">
                            <div>
                                <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    Upload Data
                                    <span className="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">
                                        {gstin?.branch} - {gstin?.id}
                                    </span>
                                </h2>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
                                <div className="w-5 h-5 flex items-center justify-center text-gray-500">✕</div>
                            </button>
                        </div>
                    )}

                    <div className="p-6 flex-1 overflow-y-auto">
                        {/* NOTE: Tabs and Mode selection removed from here as they are now handled by the parent UploadDataContent */}

                        {/* Filters and Actions Toolbar */}
                        <div className="flex flex-wrap gap-3 mb-6 justify-between items-center">
                            <div className="flex gap-3 flex-1">
                                <button className="flex items-center px-3 py-2 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    <Filter size={16} className="mr-2"/> Filter <ChevronDown size={14} className="ml-1"/>
                                </button>
                                <div className="relative flex-1 max-w-md">
                                    <Search size={16} className="absolute left-3 top-2.5 text-gray-400"/>
                                    <input type="text" placeholder="Search by Invoice Number..." className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                            </div>
                            <div className="flex gap-2 items-center">
                                <button className="px-3 py-2 bg-[#1a2332] text-white rounded-md text-sm font-medium hover:bg-[#2c3e50] flex items-center shadow-sm transition-colors"><RefreshCw size={14} className="mr-2"/> Refresh</button>
                                <button className="px-3 py-2 bg-[#1a2332] text-white rounded-md text-sm font-medium hover:bg-[#2c3e50] flex items-center shadow-sm transition-colors"><UploadCloud size={14} className="mr-2"/> Upload</button>
                                <div className="flex bg-white border border-gray-300 p-1 rounded-md ml-2">
                                    <button onClick={() => setLocalViewType('Summary')} className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${localViewType === 'Summary' ? 'bg-[#1a2332] text-white shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>Summary View</button>
                                    <button onClick={() => setLocalViewType('Invoice')} className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${localViewType === 'Invoice' ? 'bg-[#1a2332] text-white shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>Invoice View</button>
                                </div>
                            </div>
                        </div>

                        {/* Main Content Area */}
                        {localViewType === 'Invoice' ? (
                            <div className="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden min-h-[400px]">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-[#f8fafc] text-gray-700 border-b border-gray-200">
                                        <tr>
                                            <th className="px-6 py-4 font-semibold text-xs uppercase">Customer GSTIN</th>
                                            <th className="px-6 py-4 font-semibold text-xs uppercase">Customer Name</th>
                                            <th className="px-6 py-4 font-semibold text-xs uppercase">Invoice Type</th>
                                            <th className="px-6 py-4 font-semibold text-xs uppercase">Invoice Date</th>
                                            <th className="px-6 py-4 font-semibold text-xs uppercase text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colSpan={5} className="px-6 py-20 text-center flex flex-col items-center justify-center">
                                            <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                                                <FileText size={32} className="text-gray-300" />
                                            </div>
                                            <span className="text-sm font-medium text-gray-500">No Invoices Found!</span>
                                            <p className="text-xs text-gray-400 mt-1">Try changing filters or upload new data.</p>
                                        </td></tr>
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {OVERVIEW_OTHER_CARDS.map((card, i) => (<InvoiceCard key={i} {...card} />))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Component for Compare Data View
        const CompareDataView = () => (
            <div className="flex flex-col h-full">
                {/* Iterator Bar - NEW ADDITION (Already present) */}
                <GstinIteratorBar
                    currentPan={currentPanData}
                    gstins={gstins}
                    editingIndex={editingIndex}
                    setEditingIndex={setEditingIndex}
                    setPanId={setCurrentPanId}
                    isCompareMode={true} // Force single-GSTIN view
                />

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6 animate-in fade-in duration-300 overflow-y-auto flex-1">
                    {/* Left Panel: Masters India Data Summary */}
                    <div className="bg-white border border-gray-200 rounded-xl shadow-md p-5 h-auto">
                        <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-3">
                            <h3 className="text-sm font-bold text-gray-800">Masters India Data Summary</h3>
                        </div>

                        {/* 1. Invoice Summary Table (Masters India) */}
                        <div className="mb-6">
                            <table className="w-full text-xs text-left">
                                <thead className="text-gray-500 border-b border-gray-200">
                                    <tr>
                                        <th className="py-2 px-1 font-medium">Invoice Type</th>
                                        <th className="py-2 px-1 text-center font-medium">Invoice Count</th>
                                        <th className="py-2 px-1 text-right font-medium">Invoice Value</th>
                                        <th className="py-2 px-1 text-right font-medium">Taxable Value</th>
                                        <th className="py-2 px-1 text-right font-medium">Total Tax</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {MASTER_INDIA_DATA.invoiceSummary.map((item) => (
                                        <tr key={item.type} className="hover:bg-gray-50">
                                            <td className="py-2 px-1 font-semibold">{item.type}</td>
                                            <td className="py-2 px-1 text-center text-gray-600">{item.count}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.invoiceValue}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.taxableValue}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.totalTax}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* 2. Nil Supply Table (Masters India) */}
                        <div className="mb-6 border-t border-gray-200 pt-4">
                            <table className="w-full text-xs text-left">
                                <thead className="text-gray-500 border-b border-gray-200">
                                    <tr>
                                        <th className="py-2 px-1 font-medium">Invoice Type</th>
                                        <th className="py-2 px-1 text-center font-medium">Invoice Count</th>
                                        <th className="py-2 px-1 text-right font-medium">Nil Supp</th>
                                        <th className="py-2 px-1 text-right font-medium">Exempted Supp</th>
                                        <th className="py-2 px-1 text-right font-medium">Non-GST Supp</th>
                                        <th className="py-2 px-1 text-center font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {MASTER_INDIA_DATA.nilSupply.map((item) => (
                                        <tr key={item.type} className="hover:bg-gray-50">
                                            <td className="py-2 px-1 font-semibold">{item.type}</td>
                                            <td className="py-2 px-1 text-center text-gray-600">{item.count}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.nil}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.exempted}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.nonGst}</td>
                                            <td className="py-2 px-1 text-center text-red-500 cursor-pointer">
                                                <Trash2 size={14} className="mx-auto hover:text-red-700" />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* 3. Document Issue Table (Masters India) */}
                        <div className="border-t border-gray-200 pt-4">
                            <table className="w-full text-xs text-left">
                                <thead className="text-gray-500 border-b border-gray-200">
                                    <tr>
                                        <th className="py-2 px-1 font-medium">Invoice Type</th>
                                        <th className="py-2 px-1 text-center font-medium">Total Issued</th>
                                        <th className="py-2 px-1 text-center font-medium">Cancelled</th>
                                        <th className="py-2 px-1 text-center font-medium">Net Issued</th>
                                        <th className="py-2 px-1 text-center font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {MASTER_INDIA_DATA.docIssue.map((item) => (
                                        <tr key={item.type} className="hover:bg-gray-50">
                                            <td className="py-2 px-1 font-semibold">{item.type}</td>
                                            <td className="py-2 px-1 text-center text-gray-700 font-bold">{item.totalIssued}</td>
                                            <td className="py-2 px-1 text-center text-gray-700 font-bold">{item.cancelled}</td>
                                            <td className="py-2 px-1 text-center text-gray-700 font-bold">{item.netIssued}</td>
                                            <td className="py-2 px-1 text-center text-red-500 cursor-pointer">
                                                <Trash2 size={14} className="mx-auto hover:text-red-700" />
                                            </td>
                        </tr>
                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Right Panel: GST Portal Summary */}
                    <div className="bg-white border border-gray-200 rounded-xl shadow-md p-5 h-auto">
                        <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-3">
                            <h3 className="text-sm font-bold text-gray-800">GST Portal Summary</h3>
                            <button className="text-xs font-medium text-blue-700 hover:text-blue-900 flex items-center">
                                <RefreshCw size={12} className="mr-1" /> Refresh
                            </button>
                        </div>

                        {/* 1. Invoice Summary Table (GST Portal) */}
                        <div className="mb-6">
                            <table className="w-full text-xs text-left">
                                <thead className="text-gray-500 border-b border-gray-200">
                                    <tr>
                                        <th className="py-2 px-1 font-medium">Invoice Type</th>
                                        <th className="py-2 px-1 text-center font-medium">Invoice Count</th>
                                        <th className="py-2 px-1 text-right font-medium">Invoice Value</th>
                                        <th className="py-2 px-1 text-right font-medium">Taxable Value</th>
                                        <th className="py-2 px-1 text-right font-medium">Total Tax</th>
                                        <th className="py-2 px-1 text-center font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {GST_PORTAL_DATA.invoiceSummary.map((item) => (
                                        <tr key={item.type} className="hover:bg-gray-50">
                                            <td className="py-2 px-1 font-semibold">{item.type}</td>
                                            <td className="py-2 px-1 text-center text-gray-600">{item.count}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.invoiceValue}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.taxableValue}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.totalTax}</td>
                                            <td className="py-2 px-1 text-center text-red-500 cursor-pointer">
                                                <Trash2 size={14} className="mx-auto hover:text-red-700" />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* 2. Nil Supply Table (GST Portal) */}
                        <div className="mb-6 border-t border-gray-200 pt-4">
                            <table className="w-full text-xs text-left">
                                <thead className="text-gray-500 border-b border-gray-200">
                                    <tr>
                                        <th className="py-2 px-1 font-medium">Invoice Type</th>
                                        <th className="py-2 px-1 text-center font-medium">Invoice Count</th>
                                        <th className="py-2 px-1 text-right font-medium">Nil Supp</th>
                                        <th className="py-2 px-1 text-right font-medium">Exempted Supp</th>
                                        <th className="py-2 px-1 text-right font-medium">Non-GST Supp</th>
                                        <th className="py-2 px-1 text-center font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {GST_PORTAL_DATA.nilSupply.map((item) => (
                                        <tr key={item.type} className="hover:bg-gray-50">
                                            <td className="py-2 px-1 font-semibold">{item.type}</td>
                                            <td className="py-2 px-1 text-center text-gray-600">{item.count}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.nil}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.exempted}</td>
                                            <td className="py-2 px-1 text-right font-mono text-gray-700">{item.nonGst}</td>
                                            <td className="py-2 px-1 text-center text-red-500 cursor-pointer">
                                                <Trash2 size={14} className="mx-auto hover:text-red-700" />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* 3. Document Issue Table (GST Portal) */}
                        <div className="border-t border-gray-200 pt-4">
                            <table className="w-full text-xs text-left">
                                <thead className="text-gray-500 border-b border-gray-200">
                                    <tr>
                                        <th className="py-2 px-1 font-medium">Invoice Type</th>
                                        <th className="py-2 px-1 text-center font-medium">Total Issued</th>
                                        <th className="py-2 px-1 text-center font-medium">Cancelled</th>
                                        <th className="py-2 px-1 text-center font-medium">Net Issued</th>
                                        <th className="py-2 px-1 text-center font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {GST_PORTAL_DATA.docIssue.map((item) => (
                                        <tr key={item.type} className="hover:bg-gray-50">
                                            <td className="py-2 px-1 font-semibold">{item.type}</td>
                                            <td className="py-2 px-1 text-center text-gray-700 font-bold">{item.totalIssued}</td>
                                            <td className="py-2 px-1 text-center text-gray-700 font-bold">{item.cancelled}</td>
                                            <td className="py-2 px-1 text-center text-gray-700 font-bold">{item.netIssued}</td>
                                            <td className="py-2 px-1 text-center text-red-500 cursor-pointer">
                                                <Trash2 size={14} className="mx-auto hover:text-red-700" />
                                            </td>
                        </tr>
                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        );

        const UploadDataContent = () => {
            const toggleBulkSelection = (id) => {
                setBulkSelectedGSTINs(prev =>
                    prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
                );
            };

            const toggleBulkSelectAll = () => {
                const allIds = gstins.map(g => g.id);
                if (bulkSelectedGSTINs.length === allIds.length) {
                    setBulkSelectedGSTINs([]);
                } else {
                    setBulkSelectedGSTINs(allIds);
                }
            };

            const handleCancelUpload = () => {
                setConfirmUploadData({ show: false, gstinId: null, isBulk: false, isBulkUpload: false });
            };

            // Show iterator for Pending list only, as Compare is handled internally
            const showIterator = uploadSubTab === 'Pending';

            return (
                <div className="flex flex-col h-full animate-in fade-in">
                    {/* Upload Confirmation Modal */}
                    <ConfirmationModal
                        data={confirmUploadData}
                        onConfirm={executeUpload}
                        onCancel={handleCancelUpload}
                    />

                    {/* Slide Over Portal */}
                    <div className={`fixed inset-0 z-[60] overflow-hidden ${showUploadSlideOver ? 'pointer-events-auto' : 'pointer-events-none'}`}>
                        <div className="absolute inset-0 overflow-hidden">
                            <div
                                className={`absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity duration-500 ease-in-out ${showUploadSlideOver ? 'opacity-100' : 'opacity-0'}`}
                                onClick={() => setShowUploadSlideOver(false)}
                            />
                            <div className={`pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 transform transition duration-500 ease-in-out sm:duration-700 ${showUploadSlideOver ? 'translate-x-0' : 'translate-x-full'}`}>
                                <div className="pointer-events-auto w-screen max-w-[85vw]">
                                    <div className="flex h-full flex-col bg-white shadow-xl">
                                        <SingleUploadViewUI
                                            gstin={slideOverGstin}
                                            isSlideOver={true}
                                            onClose={() => setShowUploadSlideOver(false)}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ITERATOR BAR (Full Width) - Visible for Pending Sub-tab */}
                    {showIterator && (
                         <GstinIteratorBar
                            currentPan={currentPanData}
                            gstins={gstins}
                            editingIndex={editingIndex}
                            setEditingIndex={setEditingIndex}
                            setPanId={setCurrentPanId}
                            isCompareMode={false}
                        />
                    )}

                    {/* Main Content Area (Scrollable with padding) */}
                    <div className="p-6 flex-1 h-full flex flex-col overflow-y-auto">

                        {/* START: Merged Tab and Mode Selection Area */}
                        <div className="flex justify-between items-end border-b border-gray-200 mb-6 shrink-0">
                            {/* Tabs */}
                            <div className="flex space-x-8">
                                {['Pending for upload', 'Upload History', 'Compare Data'].map(subTab => (
                                    <button
                                        key={subTab}
                                        onClick={() => setUploadSubTab(subTab.split(' ')[0])}
                                        className={`pb-3 text-sm font-medium transition-colors ${uploadSubTab === subTab.split(' ')[0] ? 'text-[#1e40af] border-b-2 border-[#1e40af]' : 'text-gray-500 hover:text-gray-700'}`}
                                    >
                                        {subTab} {subTab === 'Pending for upload' && <span className="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full ml-1">0</span>}
                                    </button>
                                ))}
                            </div>

                            {/* Right side actions - Mode switch is only shown for Pending tab */}
                            <div className="flex flex-col items-end mb-2 gap-2">
                                {uploadSubTab === 'Pending' && (
                                    <div className="flex items-center gap-3">
                                         <div className="flex bg-white border border-gray-300 p-1 rounded-md">
                                            <button onClick={() => setUploadMode('Bulk')} className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${uploadMode === 'Bulk' ? 'bg-[#1a2332] text-white shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>Bulk Upload</button>
                                            <button onClick={() => setUploadMode('Single')} className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${uploadMode === 'Single' ? 'bg-[#1a2332] text-white shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>Single GSTIN</button>
                                        </div>
                                    </div>
                                )}
                                {uploadSubTab === 'Compare' ? (
                                    <div className="flex gap-3">
                                        <a href="#" className="text-xs font-medium text-blue-700 flex items-center hover:underline">
                                            <Link size={12} className="mr-1" /> E-Invoice Vs Sales Register Reconciliation
                                        </a>
                                        <button className="flex items-center px-3 py-1.5 bg-[#1a2332] text-white rounded text-xs font-medium hover:bg-[#2c3e50] shadow-sm transition-colors">
                                            <Download size={14} className="mr-1"/> Export
                                        </button>
                                    </div>
                                ) : (
                                    <a href="#" className="text-xs font-medium text-blue-700 flex items-center hover:underline">
                                        <Link size={12} className="mr-1" /> E-Invoice Vs Sales Register Reconciliation
                                    </a>
                                )}
                            </div>
                        </div>
                        {/* END: Merged Tab and Mode Selection Area */}

                        {/* Render Logic using Conditional Rendering */}
                        {(() => {
                            if (uploadSubTab === 'Pending') {
                                if (uploadMode === 'Bulk') {
                                    return (
                                        <div className="space-y-6">

                                            <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center">
                                                <div>
                                                    <h3 className="text-sm font-bold text-gray-800">Bulk Upload for PAN: {currentPanData.pan}</h3>
                                                    <p className="text-xs text-gray-500 mt-1">Select GSTINs to upload data in bulk.</p>
                                                </div>
                                                <div className="flex gap-3">
                                                    <button className="flex items-center px-4 py-2 bg-white border border-gray-300 rounded-md text-xs font-medium text-gray-700 hover:bg-gray-50">
                                                        <Download size={14} className="mr-2"/> Export Bulk Pan
                                                    </button>
                                                    <button
                                                        onClick={() => handleRequestUpload(null, true)} // BULK UPLOAD CONFIRMATION
                                                        disabled={bulkSelectedGSTINs.length === 0}
                                                        className={`flex items-center px-4 py-2 rounded-md text-xs font-medium text-white transition-colors ${bulkSelectedGSTINs.length > 0 ? 'bg-[#1e40af] hover:bg-blue-800' : 'bg-gray-300 cursor-not-allowed'}`}
                                                    >
                                                        <UploadCloud size={14} className="mr-2"/> Upload Selected ({bulkSelectedGSTINs.length})
                                                    </button>
                                                </div>
                                            </div>

                                            <div className="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                                                <div className="px-6 py-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                                    <div className="flex items-center gap-2 cursor-pointer" onClick={toggleBulkSelectAll}>
                                                        <div className={`w-4 h-4 rounded border flex items-center justify-center ${bulkSelectedGSTINs.length === gstins.length ? 'bg-blue-600 border-blue-600' : 'bg-white border-gray-300'}`}>
                                                            {bulkSelectedGSTINs.length === gstins.length && <Check size={12} className="text-white" />}
                                                        </div>
                                                        <span className="text-xs font-bold text-gray-700">Select All GSTINs</span>
                                                    </div>
                                                </div>
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-white text-gray-500 border-b border-gray-100">
                                                        <tr>
                                                            <th className="px-6 py-3 w-10"></th>
                                                            <th className="px-6 py-3 font-medium">GSTIN Details</th>
                                                            <th className="px-6 py-3 font-medium text-right">Taxable Value</th>
                                                            <th className="px-6 py-3 font-medium text-right">Tax Liability</th>
                                                            <th className="px-6 py-3 font-medium">Status</th>
                                                            <th className="px-6 py-3 font-medium">OTP Verified</th>
                                                            <th className="px-6 py-3 font-medium text-right">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-100">
                                                        {gstins.map((gstin, idx) => (
                                                            <tr key={gstin.id} className={`hover:bg-gray-50 transition-colors ${bulkSelectedGSTINs.includes(gstin.id) ? 'bg-blue-50/30' : ''}`}>
                                                                <td className="px-6 py-4">
                                                                    <div
                                                                        className={`w-4 h-4 rounded border flex items-center justify-center cursor-pointer ${bulkSelectedGSTINs.includes(gstin.id) ? 'bg-blue-600 border-blue-600' : 'bg-white border-gray-300'}`}
                                                                        onClick={() => toggleBulkSelection(gstin.id)}
                                                                    >
                                                                        {bulkSelectedGSTINs.includes(gstin.id) && <Check size={12} className="text-white" />}
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-4">
                                                                    <div className="font-medium text-gray-900">{gstin.branch}</div>
                                                                    <div className="text-xs text-gray-500 font-mono">{gstin.id}</div>
                                                                </td>
                                                                <td className="px-6 py-4 text-right text-xs text-gray-600 font-mono">
                                                                    ₹ {gstin.taxableValue.toLocaleString()}
                                                                </td>
                                                                <td className="px-6 py-4 text-right text-xs text-gray-600 font-mono">
                                                                    ₹ {gstin.liability.toLocaleString()}
                                                                </td>
                                                                <td className="px-6 py-4">
                                                                    {gstin.uploadStatus === 'Uploaded' ? <span className="text-xs text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200">Uploaded</span> : <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded border border-gray-200">Pending</span>}
                                                                </td>
                                                                <td className="px-6 py-4">
                                                                    {gstin.otpStatus === 'Verified' && (
                                                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                                                                            <Check size={10} className="mr-1" /> Verified
                                                                        </span>
                                                                    )}
                                                                    {gstin.otpStatus === 'Pending' && (
                                                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                                                                            Pending
                                                                        </span>
                                                                    )}
                                                                    {gstin.otpStatus === 'Expired' && (
                                                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-50 text-red-600 border border-red-200">
                                                                            Expired
                                                                        </span>
                                                                    )}
                                                                    {!gstin.otpStatus && <span className="text-gray-400">-</span>}
                                                                </td>
                                                                <td className="px-6 py-4 text-right">
                                                                    <div className="flex justify-end items-center gap-3">
                                                                        <button
                                                                            onClick={() => handleViewGstin(idx)}
                                                                            className="text-blue-600 hover:text-blue-800 text-xs font-medium"
                                                                        >
                                                                            View
                                                                        </button>
                                                                        <div className="h-3 w-px bg-gray-300"></div>
                                                                        {gstin.uploadStatus === 'Pending' && (
                                                                            <>
                                                                            <button
                                                                                onClick={() => handleRequestUpload(gstin.id, false)} // SINGLE UPLOAD CONFIRMATION
                                                                                className="text-green-600 hover:text-green-800 text-xs font-medium"
                                                                            >
                                                                                Upload
                                                                            </button>
                                                                            <div className="h-3 w-px bg-gray-300"></div>
                                                                            </>
                                                                        )}
                                                                        <button
                                                                            onClick={() => handleExportGstin(gstin.id)}
                                                                            className="text-gray-600 hover:text-gray-800 text-xs font-medium"
                                                                            >
                                                                            Export
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    );
                                } else {
                                    // Single Upload Pending View (Uses reusable component)
                                    // Need to force editingIndex for this view
                                    if (editingIndex === -1 && gstins.length > 0) {
                                         setEditingIndex(0);
                                    }
                                    if (!currentEditingGstin) return <EmptyStateBlock title="Please select a GSTIN from the dropdown above." />;

                                    return (
                                        <div className="-mx-6 -my-6 h-full">
                                            <SingleUploadViewUI gstin={currentEditingGstin} isSlideOver={false} />
                                        </div>
                                    );
                                }
                            } else if (uploadSubTab === 'History') {
                                // Upload History Screen - Populated with UPLOAD_HISTORY_DATA
                                return (
                                    <div className="space-y-6 animate-in fade-in duration-300">

                                        <div className="flex justify-end items-center gap-3">
                                            <button
                                                onClick={handleSwitchToPendingUpload}
                                                className="flex items-center px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 shadow-sm transition-colors"
                                            >
                                                <UploadCloud size={16} className="mr-2" /> Upload Data
                                            </button>
                                            <button className="flex items-center px-4 py-2 bg-[#1a2332] text-white rounded text-sm font-medium hover:bg-[#2c3e50] shadow-sm transition-colors">
                                                <RotateCcw size={16} className="mr-2" /> Reset GSTR-1
                                            </button>
                                        </div>

                                        <div className="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden min-h-[400px]">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-[#f9fafb] text-gray-700 border-b border-gray-200">
                                                    <tr>
                                                        <th className="px-6 py-4 font-semibold text-xs uppercase">Category</th>
                                                        <th className="px-6 py-4 font-semibold text-xs uppercase">Type</th>
                                                        <th className="px-6 py-4 font-semibold text-xs uppercase cursor-pointer group">
                                                            <div className="flex items-center">Date & Time <ArrowUpDown size={12} className="ml-1 text-gray-400 group-hover:text-gray-600" /></div>
                                                        </th>
                                                        <th className="px-6 py-4 font-semibold text-xs uppercase cursor-pointer group">
                                                            <div className="flex items-center">User ID <ArrowUpDown size={12} className="ml-1 text-gray-400 group-hover:text-gray-600" /></div>
                                                        </th>
                                                        <th className="px-6 py-4 font-semibold text-xs uppercase cursor-pointer group">
                                                            <div className="flex items-center">Status <ArrowUpDown size={12} className="ml-1 text-gray-400 group-hover:text-gray-600" /></div>
                                                        </th>
                                                        <th className="px-6 py-4 font-semibold text-xs uppercase text-right">Download Error File</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {UPLOAD_HISTORY_DATA.map(item => (
                                                        <tr key={item.id} className="hover:bg-gray-50 transition-colors">
                                                            <td className="px-6 py-4 text-xs font-medium text-gray-700">{item.category}</td>
                                                            <td className="px-6 py-4 text-xs font-medium text-gray-700">
                                                                <span className="text-gray-900 font-semibold block">{item.uploadType}</span>
                                                                <span className="text-gray-500 font-mono text-[10px]">{item.gstin}</span>
                                                            </td>
                                                            <td className="px-6 py-4 text-xs text-gray-600">{item.uploadDate}</td>
                                                            <td className="px-6 py-4 text-xs text-gray-600">{item.uploadedBy}</td>
                                                            <td className="px-6 py-4">
                                                                <UploadStatusBadge status={item.status} />
                                                            </td>
                                                            <td className="px-6 py-4 text-right">
                                                                {item.errorFile ? (
                                                                    <button
                                                                        onClick={() => handleDownloadErrorFile(item.errorFile)}
                                                                        className="flex items-center justify-end text-red-600 hover:text-red-800 text-xs font-semibold hover:underline"
                                                                    >
                                                                        <FileWarning size={14} className="mr-1"/> Download Error
                                                                    </button>
                                                                ) : (
                                                                    <span className="text-gray-400 text-xs">-</span>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {UPLOAD_HISTORY_DATA.length === 0 && (
                                                        <tr>
                                                            <td colSpan={6} className="px-6 py-24 text-center">
                                                                <div className="flex flex-col items-center justify-center">
                                                                    <div className="w-16 h-16 bg-blue-500 rounded-lg flex items-center justify-center mb-4 text-white shadow-md">
                                                                        <HardDriveDownload size={32} />
                                                                    </div>
                                                                    <span className="text-sm font-medium text-gray-600">No Data Found!</span>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                );
                            } else if (uploadSubTab === 'Compare') {
                                // Compare Data Screen - render CompareDataView (which contains its own iterator)
                                // This view needs to break out of the p-6 padding to be full width
                                return (
                                    <div className="-mx-6 -mb-6 h-full">
                                        <CompareDataView />
                                    </div>
                                );
                            } else {
                                return <div className="p-10 text-center text-gray-500">Feature Coming Soon</div>;
                            }
                        })()}

                    </div>
                </div>
            );
        };

        const PrepareContent = () => {
            // Helper to handle Consolidated View (index -1)
            const isConsolidated = editingIndex === -1;
            const currentGstinData = isConsolidated ? null : gstins[editingIndex];

            return (
                <div className="flex flex-col h-full">
                    {/* Iterator Bar - Reusing for Prepare Content (Already done) */}
                    <GstinIteratorBar
                        currentPan={currentPanData}
                        gstins={gstins}
                        editingIndex={editingIndex}
                        setEditingIndex={setEditingIndex}
                        setPanId={setCurrentPanId}
                        isCompareMode={false} // Allow consolidated view here
                    />

                    <div className="p-6 bg-gray-50 flex-1 overflow-y-auto">
                        {/* Show Warning Banner if in Consolidated Mode */}
                        {isConsolidated && (
                            <div className="mb-6 bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-md flex items-start gap-3">
                                <Info size={20} className="shrink-0 mt-0.5" />
                                <div>
                                    <p className="text-sm font-bold">Viewing Consolidated Data</p>
                                    <p className="text-xs mt-1 opacity-90">You are viewing aggregated summary data for all GSTINs under this PAN ({currentPanData.pan}). Edits made here may not be reflected at the GSTIN level automatically unless distributed.</p>
                                </div>
                            </div>
                        )}

                        {PREPARE_SECTIONS.map((sectionTitle, index) => (
                            <div key={index} className="mb-8">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-base font-bold text-gray-800">{sectionTitle}</h3>
                                </div>
                                {index === 0 ? (
                                    <div className="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-xs text-left whitespace-nowrap">
                                                <thead className="bg-[#f8fafc] text-gray-600 border-b border-gray-200 font-semibold">
                                                    <tr>
                                                        <th className="px-4 py-3">Type</th>
                                                        <th className="px-4 py-3">Place of Supply</th>
                                                        <th className="px-4 py-3">Rate</th>
                                                        <th className="px-4 py-3 text-right">Taxable Value</th>
                                                        <th className="px-4 py-3 text-right">IGST</th>
                                                        <th className="px-4 py-3 text-right">CGST</th>
                                                        <th className="px-4 py-3 text-right">SGST/UTGST</th>
                                                        <th className="px-4 py-3 text-right">CESS</th>
                                                        <th className="px-4 py-3">E-Commerce TIN</th>
                                                        <th className="px-4 py-3 text-center">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {/* Show mock data if viewing first GSTIN OR Consolidated (aggregated mock) */}
                                                    {(isConsolidated || (currentGstinData && currentGstinData.id === gstins[0]?.id)) ? (
                                                        <tr className="hover:bg-gray-50">
                                                            <td className="px-4 py-3">E-Commerce</td>
                                                            <td className="px-4 py-3">06-Haryana</td>
                                                            <td className="px-4 py-3">18.0%</td>
                                                            <td className="px-4 py-3 text-right font-medium">₹ 45,000.00</td>
                                                            <td className="px-4 py-3 text-right">₹ 0.00</td>
                                                            <td className="px-4 py-3 text-right">₹ 4,050.00</td>
                                                            <td className="px-4 py-3 text-right">₹ 4,050.00</td>
                                                            <td className="px-4 py-3 text-right">₹ 0.00</td>
                                                            <td className="px-4 py-3 text-gray-400">-</td>
                                                            <td className="px-4 py-3 text-center text-blue-600 cursor-pointer">
                                                                {isConsolidated ? <Eye size={14}/> : <Edit size={14}/>}
                                                            </td>
                                                        </tr>
                                                    ) : (
                                                        <tr>
                                                            <td colSpan={10} className="px-6 py-12 text-center text-gray-400">No Data Found for {currentGstinData?.branch || 'this branch'}</td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ) : (
                                    <EmptyStateBlock title={sectionTitle} />
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const FileReturnContent = () => {
            const toggleSelection = (id) => {
                if (selectedForFiling.includes(id)) setSelectedForFiling(prev => prev.filter(x => x !== id));
                else setSelectedForFiling(prev => [...prev, id]);
            };

            const toggleSelectAll = () => {
                const readyGstins = gstins.filter(g => g.status === 'Ready');
                const readyIds = readyGstins.map(g => g.id);

                const allReadySelected = readyIds.every(id => selectedForFiling.includes(id));

                if (allReadySelected) {
                    setSelectedForFiling(prev => prev.filter(id => !readyIds.includes(id)));
                } else {
                    const newSelection = new Set([...selectedForFiling, ...readyIds]);
                    setSelectedForFiling(Array.from(newSelection));
                }
            };

            const selectedLiability = gstins.filter(g => selectedForFiling.includes(g.id)).reduce((acc, curr) => acc + curr.liability, 0);
            const selectedTaxable = gstins.filter(g => selectedForFiling.includes(g.id)).reduce((acc, curr) => acc + curr.taxableValue, 0);

            const readyGstinsCount = gstins.filter(g => g.status === 'Ready').length;
            const allReadySelected = readyGstinsCount > 0 && gstins.filter(g => g.status === 'Ready').every(g => selectedForFiling.includes(g.id));

            // --- Filing Progress Overlay Component ---
            if (isFiling) {
                return (
                    <div className="p-8 max-w-4xl mx-auto h-full flex flex-col justify-center animate-in fade-in zoom-in-95 duration-300">
                        <div className="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                            <div className="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                <div>
                                    <h3 className="text-lg font-bold text-gray-800">Filing Returns via {filingMode}</h3>
                                    <p className="text-sm text-gray-500">Processing selected GSTINs securely.</p>
                                </div>
                                <div className="text-right">
                                    <div className="text-2xl font-bold text-blue-600">{overallProgress}%</div>
                                    <div className="text-xs text-gray-500 font-medium uppercase">Completed</div>
                                </div>
                            </div>
                            <div className="h-1 w-full bg-gray-100">
                                <div
                                    className="h-full bg-blue-600 transition-all duration-500 ease-out"
                                    style={{ width: `${overallProgress}%` }}
                                ></div>
                            </div>

                            <div className="max-h-[60vh] overflow-y-auto p-6 space-y-4">
                                {filingProgress.map((item, idx) => (
                                    <div key={item.id} className="flex items-center p-4 border border-gray-100 rounded-lg bg-white shadow-sm">
                                        <div className="mr-4">
                                            {item.status === 'pending' && <div className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400"><RefreshCw size={16} /></div>}
                                            {item.status === 'verifying' && <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 animate-spin"><RefreshCw size={16} /></div>}
                                            {item.status === 'verified' && <div className="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600"><Check size={20} /></div>}
                                            {item.status === 'failed' && <div className="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"><AlertTriangle size={20} /></div>}
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex justify-between mb-1">
                                                <span className="font-semibold text-gray-900">{item.branch}</span>
                                                <span className="text-xs font-mono text-gray-500">{item.id}</span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className={`text-sm ${
                                                    item.status === 'verifying' ? 'text-blue-600 font-medium' :
                                                    item.status === 'verified' ? 'text-green-600 font-medium' :
                                                    item.status === 'failed' ? 'text-red-600 font-medium' :
                                                    'text-gray-400'
                                                }`}>
                                                    {item.message}
                                                </span>
                                            </div>
                                            {item.status === 'verifying' && (
                                                <div className="mt-2 h-1.5 w-full bg-blue-50 rounded-full overflow-hidden">
                                                    <div className="h-full bg-blue-500 animate-pulse rounded-full w-2/3"></div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="p-4 bg-gray-50 border-t border-gray-100 text-center">
                                {overallProgress === 100 ? (
                                    <button onClick={() => { setIsFiling(false); setSelectedForFiling([]); }} className="px-6 py-2 bg-gray-900 text-white rounded-md text-sm font-medium hover:bg-gray-800 transition-colors">
                                        Close & View Status
                                    </button>
                                ) : (
                                    <p className="text-xs text-gray-400">Please do not close this window or refresh the page.</p>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full">
                    {/* Iterator Bar for context alignment in File Return screen */}
                    <GstinIteratorBar
                        currentPan={currentPanData}
                        gstins={gstins}
                        editingIndex={editingIndex}
                        setEditingIndex={setEditingIndex}
                        setPanId={setCurrentPanId}
                        isCompareMode={false}
                    />
                    <div className="p-6 h-full flex flex-col animate-in fade-in flex-1 overflow-y-auto">
                        {/* Top Header */}
                        <div className="flex justify-between items-end mb-4 shrink-0">
                            <div>
                                <h2 className="text-lg font-bold text-gray-800">File Returns for PAN: {currentPanData.pan}</h2>
                                <p className="text-sm text-gray-500">Select multiple GSTINs to file GSTR-1 in bulk.</p>
                            </div>
                            {/* Removed Upload Buttons: Summary Upload and Invoice Upload */}
                        </div>

                        {/* Bulk Action Toolbar (Moved from Sidebar) */}
                        <div className="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm flex flex-col lg:flex-row items-center justify-between gap-4 shrink-0">
                            {/* Metrics */}
                            <div className="flex items-center gap-8 w-full lg:w-auto border-b lg:border-b-0 lg:border-r border-gray-100 pb-4 lg:pb-0 lg:pr-8">
                                <div className="flex flex-col">
                                    <span className="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Selected</span>
                                    <span className="text-xl font-bold text-gray-900">{selectedForFiling.length} <span className="text-xs font-medium text-gray-500">Units</span></span>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Taxable Value</span>
                                    <span className="text-xl font-bold text-gray-900">₹ {selectedTaxable.toLocaleString()}</span>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Total Liability</span>
                                    <span className="text-xl font-bold text-blue-600">₹ {selectedLiability.toLocaleString()}</span>
                                </div>
                            </div>

                            {/* Actions Group */}
                            <div className="flex flex-wrap items-center gap-4 justify-end w-full lg:w-auto">
                                <button
                                    onClick={() => handleFileReturn()}
                                    disabled={selectedForFiling.length === 0}
                                    className="px-4 py-2 border border-blue-200 text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-md text-sm font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Proceed to File
                                </button>

                                <div className="h-8 w-px bg-gray-200 hidden lg:block"></div>

                                {/* Filing Method Toggle */}
                                <div className="flex items-center gap-3 bg-gray-50 p-1.5 rounded-lg border border-gray-200">
                                    <div className="flex bg-white rounded shadow-sm border border-gray-200">
                                        <button
                                            onClick={() => setFilingMode('EVC')}
                                            className={`px-3 py-1.5 text-xs font-bold rounded-l transition-colors ${filingMode === 'EVC' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                                        >
                                            File via EVC
                                        </button>
                                        <button
                                            onClick={() => setFilingMode('DSC')}
                                            className={`px-3 py-1.5 text-xs font-bold rounded-r transition-colors ${filingMode === 'DSC' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                                        >
                                            File with DSC
                                        </button>
                                    </div>

                                    {filingMode === 'EVC' && (
                                         <span className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded border border-green-200 font-medium">Auto-Mode</span>
                                    )}
                                </div>

                                <button
                                    onClick={() => handleFileReturn()}
                                    disabled={selectedForFiling.length === 0}
                                    className="px-6 py-2 bg-[#1a2332] text-white rounded-md font-bold text-sm hover:bg-[#2c3e50] disabled:opacity-50 disabled:cursor-not-allowed shadow-md transition-all flex items-center"
                                >
                                    File GSTR1
                                    <ArrowRight size={14} className="ml-2" />
                                </button>
                            </div>
                        </div>

                        {/* Main Selection Table Area */}
                        <div className="flex-1 bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden flex flex-col min-h-0">
                            <div className="px-6 py-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center shrink-0">
                                <div className="flex items-center gap-3 cursor-pointer" onClick={toggleSelectAll}>
                                    <div className={`w-4 h-4 rounded border flex items-center justify-center transition-colors ${allReadySelected ? 'bg-blue-600 border-blue-600' : 'bg-white border-gray-300'}`}>
                                        {allReadySelected && <Check size={12} className="text-white" />}
                                    </div>
                                    <span className="text-sm font-bold text-gray-800">Select All Ready GSTINs</span>
                                </div>
                                <span className="text-xs font-medium text-gray-500">Showing Ready ({readyGstinsCount})</span>
                            </div>

                            <div className="flex-1 overflow-y-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-white text-gray-500 border-b border-gray-100 sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th className="px-6 py-3 w-10 bg-gray-50"></th>
                                            <th className="px-6 py-3 font-medium bg-gray-50">GSTIN Details</th>
                                            <th className="px-6 py-3 font-medium text-right bg-gray-50">Return Period</th>
                                            <th className="px-6 py-3 font-medium text-right bg-gray-50">Taxable Value</th>
                                            <th className="px-6 py-3 font-medium text-right bg-gray-50">Tax Liability</th>
                                            <th className="px-6 py-3 font-medium bg-gray-50">Status</th>
                                            <th className="px-6 py-3 font-medium bg-gray-50">OTP Verified</th>
                                            <th className="px-6 py-3 font-medium bg-gray-50">Filing Method</th>
                                            <th className="px-6 py-3 font-medium text-right bg-gray-50">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {gstins.map(g => (
                                            <tr key={g.id} className={`hover:bg-gray-50 transition-colors ${selectedForFiling.includes(g.id) ? 'bg-blue-50/30' : ''}`}>
                                                <td className="px-6 py-4">
                                                    <div
                                                        className={`w-4 h-4 rounded border flex items-center justify-center cursor-pointer ${selectedForFiling.includes(g.id) ? 'bg-blue-600 border-blue-600' : 'bg-white border-gray-300'}`}
                                                        onClick={() => g.status === 'Ready' && toggleSelection(g.id)}
                                                    >
                                                        {selectedForFiling.includes(g.id) && <Check size={12} className="text-white" />}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="font-medium text-gray-900">{g.branch}</div>
                                                    <div className="text-xs text-gray-500 font-mono">{g.id}</div>
                                                </td>
                                                <td className="px-6 py-4 text-xs text-gray-500 whitespace-nowrap text-right">
                                                    {g.returnPeriod || 'Nov 2025'}
                                                </td>
                                                <td className="px-6 py-4 text-right text-gray-900 font-mono text-xs">
                                                    ₹ {g.taxableValue.toLocaleString()}
                                                </td>
                                                <td className="px-6 py-4 text-right text-gray-900 font-mono text-xs">
                                                    ₹ {g.liability.toLocaleString()}
                                                </td>
                                                <td className="px-6 py-4">
                                                    <StatusBadge status={g.status} />
                                                </td>
                                                <td className="px-6 py-4">
                                                    {g.otpStatus === 'Verified' && (
                                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                                                            <Check size={10} className="mr-1" /> Verified
                                                        </span>
                                                    )}
                                                    {g.otpStatus === 'Pending' && (
                                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                                                            Pending
                                                        </span>
                                                    )}
                                                    {g.otpStatus === 'Expired' && (
                                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-50 text-red-600 border border-red-200">
                                                            Expired
                                                        </span>
                                                    )}
                                                    {!g.otpStatus && <span className="text-gray-400">-</span>}
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="relative">
                                                        <select
                                                            value={g.filingType || 'EVC'}
                                                            onChange={(e) => handleFilingTypeChange(g.id, e.target.value)}
                                                            disabled={g.status !== 'Ready'}
                                                            className={`
                                                                appearance-none w-24 pl-3 pr-8 py-1.5 rounded text-xs font-semibold cursor-pointer outline-none focus:ring-2 focus:ring-blue-500 transition-all
                                                                ${g.filingType === 'DSC'
                                                                    ? 'bg-purple-50 text-purple-700 border border-purple-200'
                                                                    : 'bg-blue-50 text-blue-700 border border-blue-200'}
                                                                ${g.status !== 'Ready' ? 'opacity-50 cursor-not-allowed' : ''}
                                                            `}
                                                        >
                                                            <option value="EVC">EVC</option>
                                                            <option value="DSC">DSC</option>
                                                        </select>
                                                        <ChevronDown size={12} className={`absolute right-2 top-2 pointer-events-none ${g.filingType === 'DSC' ? 'text-purple-400' : 'text-blue-400'}`} />
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 text-right">
                                                    <div className="flex justify-end items-center gap-3">
                                                        <button
                                                            onClick={() => handleFileReturn(g.id)}
                                                            disabled={g.status !== 'Ready'}
                                                            className={`text-xs font-bold hover:underline ${g.status === 'Ready' ? 'text-blue-600 hover:text-blue-800' : 'text-gray-300 cursor-not-allowed'}`}
                                                        >
                                                            File
                                                        </button>
                                                        <button className="text-gray-400 hover:text-blue-600 transition-colors p-1 hover:bg-blue-50 rounded">
                                                            <Download size={16} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        return (
            <div className="flex h-screen bg-[#f3f4f6] font-sans text-gray-900">
                <div className="w-64 bg-white border-r border-gray-200 flex flex-col shrink-0 z-50 shadow-xl">
                    <div className="h-16 bg-[#1a2332] flex items-center px-5 space-x-3 shrink-0">
                        <div className="w-8 h-8 bg-white rounded-md flex items-center justify-center text-[#1a2332] font-black text-lg">M</div>
                        <span className="font-bold text-white text-lg tracking-wide">Masters India</span>
                    </div>
                    <div className="flex-1 overflow-y-auto py-4">
                        <div className="space-y-0.5">
                            <SidebarItem icon={LayoutDashboard} label="Dashboard" />
                            <SidebarItem icon={UploadCloud} label="Data Import" />
                            <SidebarItem icon={FileText} label="GST Return" active />
                            <SidebarItem icon={Receipt} label="IMS" />
                            <SidebarItem icon={Calculator} label="GST Reconciliation" />
                            <SidebarItem icon={CreditCard} label="Challans & Payment" />
                            <SidebarItem icon={Bell} label="Notices & Orders" badge="102" />
                            <SidebarItem icon={FileCheck} label="Reports" />
                            <SidebarItem icon={Settings} label="Tax GPT" badge="BETA" />
                            <SidebarItem icon={Settings} label="Configurations" />
                        </div>
                    </div>
                    <div className="p-4 border-t border-gray-100 bg-gray-50/50">
                        <div className="flex items-center space-x-3 text-xs font-semibold text-gray-500 mb-4">
                            <Grid size={14} /> <span>Try MI Products</span>
                        </div>
                        <div className="flex items-center space-x-3 text-xs font-semibold text-gray-500">
                            <HelpCircle size={14} /> <span>Help & Support</span>
                        </div>
                    </div>
                </div>
                <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                    <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0 z-40">
                        <div className="flex items-center text-sm text-gray-500">
                            <span className="hover:text-gray-800 cursor-pointer">GST Returns</span>
                            <span className="mx-2">/</span>
                            <span className="hover:text-gray-800 cursor-pointer">GSTR 1</span>
                            <span className="mx-2">/</span>
                            <span className="font-semibold text-blue-800">{activeTab}</span>
                        </div>
                        <div className="flex items-center space-x-4">
                            <div className="hidden md:flex items-center px-3 py-1.5 bg-gray-50 border border-gray-200 rounded text-sm font-medium text-gray-700">
                                <span>Nov - 2025-26</span>
                                <ChevronDown size={14} className="ml-2 text-gray-400" />
                            </div>
                            <div className="relative group">
                                <button className="flex items-center justify-between min-w-[240px] px-3 py-1.5 bg-white border border-gray-300 hover:border-blue-400 rounded transition-all shadow-sm">
                                    <div className="text-left">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">
                                            {editingIndex === -1 ? 'PAN View (Consolidated)' : 'Single View'}
                                        </p>
                                        <p className="text-sm font-bold text-gray-900 truncate w-40">
                                            {editingIndex === -1 ? currentPanData.pan : currentEditingGstin?.branch}
                                        </p>
                                    </div>
                                    <ChevronDown size={16} className="text-gray-400" />
                                </button>
                                <div className="absolute right-0 top-full mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                                    <div className="p-2">
                                        <div onClick={() => handleGlobalContextChange('PAN')} className={`p-2 rounded cursor-pointer flex items-center justify-between ${editingIndex === -1 ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-50'}`}>
                                            <span className="text-sm font-bold">All Branches (PAN)</span>
                                            {editingIndex === -1 && <Check size={14} />}
                                        </div>
                                        <div className="h-px bg-gray-100 my-2"></div>
                                        <p className="px-2 text-[10px] font-bold text-gray-400 uppercase mb-1">Select Specific Branch</p>
                                        <div className="max-h-48 overflow-y-auto">
                                            {gstins.map((g, idx) => (
                                                <div key={g.id} onClick={() => handleGlobalContextChange('SINGLE', idx)} className={`p-2 rounded cursor-pointer flex items-center justify-between ${editingIndex !== -1 && editingIndex === idx ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-50'}`}>
                                                    <div className="truncate">
                                                        <div className="text-sm font-medium">{g.branch}</div>
                                                        <div className="text-[10px] text-gray-500 font-mono">{g.id}</div>
                                                    </div>
                                                    {editingIndex !== -1 && editingIndex === idx && <Check size={14} />}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-100 to-blue-200 border border-blue-200 flex items-center justify-center text-blue-700 font-bold text-xs">MA</div>
                        </div>
                    </header>
                    <div className="bg-white border-b border-gray-200 px-6 flex items-center justify-between shrink-0">
                        <div className="flex space-x-8">
                            {['Overview', 'Prepare', 'Upload Data', 'File Return'].map((tab) => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`py-3 text-sm font-medium border-b-2 transition-all ${activeTab === tab ? 'border-blue-800 text-blue-800' : 'border-transparent text-gray-500 hover:text-gray-800'}`}>{tab}</button>
                            ))}
                        </div>
                        <div className="py-2">
                            <button className="text-xs font-medium text-blue-700 flex items-center hover:underline">
                                <Link size={12} className="mr-1" /> E-Invoice Reconciliation
                            </button>
                        </div>
                    </div>
                    <main className="flex-1 overflow-y-auto relative">
                        {activeTab === 'Overview' && <OverviewContent />}
                        {activeTab === 'Prepare' && <PrepareContent />}
                        {activeTab === 'Upload Data' && <UploadDataContent />}
                        {activeTab === 'File Return' && <FileReturnContent />}
                    </main>
                </div>
            </div>
        );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
